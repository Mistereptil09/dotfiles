#!/bin/bash

# Enhanced Fedora Bootstrap Script
# Minimal Hyprland setup with GPU detection and colored output
# Expected to be run on a fresh Fedora installation

set -e  # Exit on any error
set -o pipefail

# Colors for better output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_step() {
    echo -e "\n${BLUE}==>${NC} ${GREEN}$1${NC}"
}

print_info() {
    echo -e "${YELLOW}ℹ${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

# Welcome message
echo -e "\n${GREEN}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║                 Fedora Bootstrap Script                      ║${NC}"
echo -e "${GREEN}║        Minimal Hyprland setup with GPU detection             ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════════╝${NC}"
print_info "This script will install and configure:"
print_info "  • Essential system utilities"
print_info "  • GPU-specific drivers (auto-detected)"
print_info "  • Hyprland wayland compositor (minimal setup)"
print_info "  • Kitty terminal and Firefox browser"
print_info "  • Zsh shell with Starship prompt"
print_info "  • Display manager configuration"
echo

# Update system first
print_step "Updating system packages..."
sudo dnf update -y
print_success "System updated successfully"

# Install essential utilities
print_step "Installing essential utilities..."
sudo dnf install -y git curl tar unzip wget zsh sudo
print_success "Essential utilities installed"

# Detect GPU and install drivers
print_step "Detecting GPU hardware and installing drivers..."
GPU_VENDOR=$(lspci | grep -E "VGA|3D" | awk '{print tolower($5)}' | head -n1)

if [[ "$GPU_VENDOR" == *nvidia* ]]; then
    print_info "NVIDIA GPU detected - installing NVIDIA drivers..."
    sudo dnf install -y akmod-nvidia xorg-x11-drv-nvidia
    print_success "NVIDIA drivers installed"
elif [[ "$GPU_VENDOR" == *amd* ]]; then
    print_info "AMD GPU detected - installing AMD drivers..."
    sudo dnf install -y xorg-x11-drv-amdgpu mesa-vulkan-drivers
    print_success "AMD drivers installed"
elif [[ "$GPU_VENDOR" == *intel* ]]; then
    print_info "Intel GPU detected - installing Intel drivers..."
    sudo dnf install -y xorg-x11-drv-intel mesa-vulkan-drivers
    print_success "Intel drivers installed"
else
    print_info "No supported GPU detected, skipping driver installation"
fi

# Install minimal Hyprland setup
print_step "Installing Hyprland wayland compositor..."
print_info "Installing minimal Hyprland with essential dependencies..."
sudo dnf install -y hyprland xdg-desktop-portal-hyprland
print_success "Hyprland installed successfully"

# Install terminal and browser
print_step "Installing terminal emulator and web browser..."
sudo dnf install -y kitty
sudo dnf install -y firefox
print_success "Kitty terminal and Firefox browser installed"

# Install Zsh
print_step "Installing Zsh shell..."
sudo dnf install -y zsh
print_success "Zsh shell installed"

# Install Starship prompt
print_step "Installing Starship prompt..."
if ! command -v starship &> /dev/null; then
    curl -sS https://starship.rs/install.sh | sh -s -- -y
    print_success "Starship prompt installed"
else
    print_info "Starship already installed, skipping..."
fi

# Handle yadm dotfiles
print_step "Checking for dotfiles configuration..."
if [ -f ~/dotfiles/install.sh ]; then
    print_info "Found dotfiles bootstrap script, executing..."
    chmod +x ~/dotfiles/install.sh
    ~/dotfiles/install.sh
    print_success "Dotfiles bootstrap completed"
else
    print_info "No install.sh found in ~/dotfiles"
    print_info "Remember to run: ${BLUE}yadm clone <your-dotfiles-repo>${NC} to set up your configurations"
fi

# Configure display manager
print_step "Configuring display manager..."
if systemctl list-unit-files | grep -q sddm; then
    sudo systemctl enable sddm
    print_success "SDDM display manager enabled"
else
    print_info "SDDM not found - you may need to install a display manager to start Hyprland"
    print_info "Consider installing: ${BLUE}sudo dnf install sddm${NC}"
fi

# Final message
echo -e "\n${GREEN}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║                   Installation Complete!                     ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════════╝${NC}"
echo
print_success "Your minimal Fedora Hyprland system has been configured with:"
echo -e "  ${GREEN}✓${NC} Essential system utilities and GPU drivers"
echo -e "  ${GREEN}✓${NC} Hyprland wayland compositor (minimal setup)"
echo -e "  ${GREEN}✓${NC} Kitty terminal emulator and Firefox browser"
echo -e "  ${GREEN}✓${NC} Zsh shell with Antidote plugin manager"
echo -e "  ${GREEN}✓${NC} Starship prompt"
echo -e "  ${GREEN}✓${NC} Display manager configuration"
echo
print_info "Next steps:"
echo -e "  ${YELLOW}1.${NC} If you haven't already: ${BLUE}yadm clone <your-dotfiles-repo>${NC}"
echo -e "  ${YELLOW}2.${NC} Restart your system or log out and back in"
echo -e "  ${YELLOW}3.${NC} Select Hyprland from your display manager session menu"
echo -e "  ${YELLOW}4.${NC} Build on this minimal setup by adding tools as needed"
echo
print_info "Minimal setup complete - you can now add waybar, wofi, mako, etc. as desired"
echo -e "\n${BLUE}Happy Hyprland-ing! 🚀${NC}"
